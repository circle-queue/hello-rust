use regex::Regex;
use std::collections::{HashMap, HashSet};

pub fn solve1(input: Vec<String>) -> String {
    let mut valid_cells = HashSet::new();

    for (i, row) in input.iter().enumerate() {
        for (j, chr) in row.chars().enumerate() {
            if chr.is_numeric() || chr == '.' {
                continue;
            }

            for i_ in (i - 1)..(i + 2) {
                for j_ in (j - 1)..(j + 2) {
                    valid_cells.replace((i_, j_));
                }
            }
        }
    }

    let mut parts_sum = 0;
    for (i, row) in input.iter().enumerate() {
        let re = Regex::new(r"\d+").unwrap();
        let matches = re.captures_iter(row).map(|c| c.get(0).unwrap());

        'capture_loop: for capture in matches {
            for j in capture.range() {
                if valid_cells.contains(&(i, j)) {
                    let part_num = capture.as_str().parse::<i32>().unwrap();
                    // dbg!(part_num);
                    parts_sum += part_num;
                    continue 'capture_loop;
                }
            }
        }
    }
    parts_sum.to_string()
}

pub fn solve2(input: Vec<String>) -> String {
    let mut valid_nums: HashMap<(usize, usize), Vec<i32>> = HashMap::new();

    for (i, row) in input.iter().enumerate() {
        let re = Regex::new(r"\d+").unwrap();
        let matches = re.captures_iter(row).map(|c| c.get(0).unwrap());

        for capture in matches {
            for i_ in i.saturating_sub(1)..(i + 2) {
                for j_ in capture.start().saturating_sub(1)..(capture.end() + 1) {
                    let num = capture.as_str().parse::<i32>().unwrap();
                    valid_nums.entry((i_, j_)).or_default().push(num);
                }
            }
        }
    }

    let mut gear_ratios = 0;
    for (i, row) in input.iter().enumerate() {
        for (j, chr) in row.chars().enumerate() {
            let adj_nums = valid_nums.entry((i, j)).or_default();
            if chr != '*' || adj_nums.len() != 2 {
                continue;
            }
            gear_ratios += adj_nums[0] * adj_nums[1]
        }
    }
    gear_ratios.to_string()
}

pub fn sample_input1() -> Vec<String> {
    vec![
        "467..114..".to_string(),
        "...*......".to_string(),
        "..35..633.".to_string(),
        "......#...".to_string(),
        "617*......".to_string(),
        ".....+.58.".to_string(),
        "..592.....".to_string(),
        "......755.".to_string(),
        "...$.*....".to_string(),
        ".664.598..".to_string(),
    ]
}

pub fn sample_input2() -> Vec<String> {
    sample_input1()
}
pub fn full_input1() -> Vec<String> {
    full_input2()
}

pub fn full_input2() -> Vec<String> {
    vec![
        "..........................380.......................143............................108.............630...........425........................".to_string(),
        "....*585..30....217*616..........$...................../....$.................447...........381..................+..........973.............".to_string(),
        ".210......*...............639...541..-........830*...........912..........743*.......................828..671........+......*...............".to_string(),
        ".......760....$..............*........737.*.......949..568.......................=........628.85........&.#..........87...535.....794.......".to_string(),
        "....#......616..........373.999..392......853..........&.........666.......*.....365.............807............@....................*......".to_string(),
        ".680................800*..............684................329....*.......960.186........725........*......&.....631.....700*818..............".to_string(),
        "............-402...........%.........@.........576.............956................../.....*....237....490........................998........".to_string(),
        "........624.........600/...283..906................301....903...........=495.....917..165..193......................................+.......".to_string(),
        "....977.+........................*........*610.....-....................................*.......489*795.......-....@545..915......*......641".to_string(),
        "...-.......123........@........113.....643............117.483../...................961.984..................878...........*........277..@...".to_string(),
        ".............$....787..80....................490......$....../..802.....591...373...*..............228..................848..840............".to_string(),
        ".613.......................810..........740......476.....902............$..........201......%.......$..-.......993......................701.".to_string(),
        "......268.......429.........$..........+....582..........@...538*789......................941...136.....334......*.........508...250........".to_string(),
        "........*...745*.........+......*77.........*......653..................#....27................/......+..........491....#....*...*....192...".to_string(),
        ".......978.............26....957......*...400.........*834.#85.......429............................291................690...69.814....#....".to_string(),
        "...276.....=.571....................65....................................765.......179..720..................460.302.......................".to_string(),
        "...*.....577...*..........................=50..758............/.52@........*..........@..............279........-...........................".to_string(),
        "..821...........676..839...227..................*..........273...........789...42.288...#.......226......................451..592......943..".to_string(),
        ".........*...................*......................................$................*..378.......*..876.497....@..575*.........*.....*.....".to_string(),
        "......524........353........664......781...../108..................124.............407........272.43.#....&..421.......708......../..405....".to_string(),
        "................*....769.............*.............../.........432..........57$..............*...................=...........887.637........".to_string(),
        "................96...*................700..%.......573........*....644..........802......798.897.......456..258.130..182......*.............".to_string(),
        "...........&.........420............#.....369..............121........$....916...*........*...............*.............*637.......*816.....".to_string(),
        "...911...97....990...................557.......................355............#.578........764.872.........80.....*792..........517.........".to_string(),
        ".....*..........*...-609....675.............657......728......%....446....963.........201......%.......232.....576.......116........630.....".to_string(),
        "..801..........352............%..............*..........*422..........*..*........538..*.........*435.*.....................*730.....*......".to_string(),
        "....................&................952..283.....931...............95...617........%..215....174.........139........375...........755.426..".to_string(),
        "..........972.......82...500........*.............*...854.......208...........853%..................=......*...........*..941...........%...".to_string(),
        "....975+.....*.....................58....$..836.899..../.........*...................@682........952........193.......13.*........711.......".to_string(),
        "............757..............45.......453...../.............603.735......155..848..........402..........954..............530...........%....".to_string(),
        "..........................................285...........596...=.............*...............*.......*....#......*681...........*162.517.....".to_string(),
        ".173.589.......892..451......268...........*............../............764...476...........206...860.123.....812.....97*319.139.............".to_string(),
        ".......*............%....981....*288....917....666..............#.........&.......532@...-...............330.........................731....".to_string(),
        "......764.......*........*...................=...+.985...952...498..+473.................98..&..663..414....*...885&...788..../.............".to_string(),
        ".............508.439.....956......799.122..786.............*.............214.................63............346........=......507............".to_string(),
        "...252*780.......................*....*.....................446............*.....900.540.................................510...........899..".to_string(),
        "...........169-......%..@........328.506................573.................367.....*..........646.896...815...691..............%141........".to_string(),
        ".................-.195.606.....&................908......./...67*49...@.........707.....#607......*........*.....=..........................".to_string(),
        "..902..@......742.............706..355&.....953...*..811...............125..490....*241..............+..468..............512....334.........".to_string(),
        "...*....463.......802.260&....................*..711.-...-......................%.................360................811.%.............%....".to_string(),
        ".113............%..*....................%861.999.......458..................334.924..425..406..........184#................712....#.....176.".to_string(),
        ".........166...689.124......*550.840.......................742................#........%......405...........26.........546*.......665.......".to_string(),
        "............*............159........*...........@879.......*.........48..................987......751.319....*...113........................".to_string(),
        "..........163............................................453...524.....$..........*936...*...........*......119..+.......756.......&...326..".to_string(),
        "777*241.......210.974.258.....528..............................$...............559.......921......@....382...............*........147...*...".to_string(),
        "....................*.*....................131*156........./................@......445.........477......*.....47=....875..730..........499..".to_string(),
        ".....682..........545..856............................165..740...831.........368..........851......926...223............*...................".to_string(),
        "....*.............................447..................@...........*..............%...418....*.....*...........838...325....................".to_string(),
        "....722.......71....848...747........*..690....275..........740...16..123..129...837.....+.359.68..426......=....-........791...617..582....".to_string(),
        ".............*............=...271...358.*.........*...................+.......*................*............378............$................".to_string(),
        "570.......620..399*666...................702.....32...............215..........896.325......377...................=286.................200..".to_string(),
        "...*833...................................................12/.247......510.........*...369........813*..........*...........................".to_string(),
        "....................................%..........-......&..........*655....*.......380....*.............778.....98.910.......752..............".to_string(),
        ".............643.783..............621....777..523.....384..$...........693...............336................................#..+............".to_string(),
        "521.........*.......*.................$...................261.31..............549.................102......467-.......219......286....$118..".to_string(),
        "..........837........904..636.298.204..368.......47............/.................*...........246...*....#.......526......*..................".to_string(),
        ".....201......497............*....*..............*................982........+..243.............*.774....488.......*..641...........140.....".to_string(),
        "838...*....+.......................296....*765..489....8....................796.......=.......200................996.........364.......*....".to_string(),
        ".......540.93....+...............................................*600.................47..................256........#..........*...+..823..".to_string(),
        "................14...-65..................328.............................407+..............54.464..990....*...305..129.......679..141......".to_string(),
        ".........................487.-.....831.......*.....407.776.409.....75.............426..782...*...*..#......347....*....................864..".to_string(),
        "....995...................=...117.../..*..531.........*......$.......*973...........*...@......614................194........172...930*.....".to_string(),
        ".......*386...........................799.....660...................................415....../.....%370...289............988................".to_string(),
        ".....-..........835+..316.47..............226......904.........789..........................32............$....616..........=...............".to_string(),
        "...243.....26............*........479%....=....@...=..............*......#.....292..............389.....@.....*...................+...$546..".to_string(),
        "..........*.....&.......................$....199......@........&..25......345.....*36...626.....*.....632..108..69*362...&561..517..........".to_string(),
        ".136*291...858...815........974.......913............786....908......495......805..........*122.948.........................................".to_string(),
        "...........................*...............103*363...............438...........*..@.@...........................%401.......90=......403.....".to_string(),
        ".313&.618....@...$521.....332............................768.......*.........428.50..445.338.....*.......................%.....115.*........".to_string(),
        ".......*.....583..............586...........=..............*.......11.......................=.171.280.........140..750...798...&....286..111".to_string(),
        ".....604..........266......................566....-.....398..238.........499........#...@......................*.....%......................".to_string(),
        ".........545*739.$............68..337*.........296..............*................694...100......&..............233..........................".to_string(),
        ".....320................468....-........997......................796...48.....................219.....&............378.552...8..............".to_string(),
        ".......$..........356+....*................*.........205................/........645*....600.........709.....................*...760........".to_string(),
        "...625..................681........870-...907.......-....142..173...859..............802...*.....................741..289*74.............705".to_string(),
        ".........244......908....................................*.../........*..................501......92.............*..........................".to_string(),
        "............*......$.....576.384..111.119.............127..............720....898....534............*....347........................487*....".to_string(),
        "....610...922...........$.....*...*..........381*36.........................../.......*......665.843.......*....754.470..690................".to_string(),
        ".....*.........$..135.......142.242.352..............................775...-.....*....67....*.........+...576......*.....#..................".to_string(),
        ".....249....735......*.......................................402-...*....903..667.419......526........294...................................".to_string(),
        ".361.....-......418.659.575......803.596......910....367...........950.....................................308........*.....................".to_string(),
        "...*......690..*...........*797.................*.......*....................160..........61.....#........*..........141.....402...599..811.".to_string(),
        "...505..............288%........525%...........355...324.................876*...............*538..39....482..696............@.........*.....".to_string(),
        "...............401........@............884..........................&.......................................*.........749.............86....".to_string(),
        ".........484......*38..370........328.*............553......&845.....662................520................46................24.............".to_string(),
        ".....407*..........................$..310..........*.....................765..672............832.......................@.657....555../..588.".to_string(),
        "..........107.789..200..213.....................898..545........67...........%................./...........101.742...422..%...=...&.622.....".to_string(),
        ".............*......*............*292......946......&..............243+.651....178...665............./.........*.............92.............".to_string(),
        "......974...........814.......220......906......$......*.....879...........*......+.....*........-...995........185.18...........254..198...".to_string(),
        "...........791..808.....984...............&...985...871.678..*.............340................973..........253.......#..................*...".to_string(),
        "..../.....*........=....*..........92*411.....................835...................%.................#.../................$.........279....".to_string(),
        "....926....292...........839...333..........600.115....................=....&.....336.....350........966......999...540..908.............705".to_string(),
        "................................*...497...........*....994..........447......131.........*...................*..............................".to_string(),
        "...........$.....-....../.....394...=.......175.417....*................................719...................992....................-......".to_string(),
        "..........960.698.....610.986.........*776..........516...34......&.....75...751...$........%.......651.....=......300...........364.905....".to_string(),
        "...317.......................*..+...........................*....783.....*..=......655.......310.....+...339..........*......256*........145".to_string(),
        "....&..107..................276.136..905......548..%.......334.........471...................................279.727..696...................".to_string(),
        "343...*......733........515..........$....357....@.301.........*348...................118.........&...439...*.......................922.....".to_string(),
        "....754.....-......646.@.................-..................929.................475......*......785......*..684..............27......*......".to_string(),
        "...................*.....463..../59.609...........168*863...................801...&..211..382..........347............28.............473....".to_string(),
        ".................725.....#...........*......79..........................978*...........*......................199.....*.........579.........".to_string(),
        "...........................157*662....958...*...............546@.................&..181...416.109..............*....258.....421*............".to_string(),
        "...859......777=.............................217.862..................817*597...655........*.........76.....443.....................292.....".to_string(),
        "...@...170..........273...........+..=.............................=................217....253..438....*....................................".to_string(),
        ".......&.......................971..876...............205.....394.502..122...........$.............$...40............802....................".to_string(),
        "..894........*.623...718..................216........*.........=.......................544.....................102............932.951..615..".to_string(),
        "....+......865........*...............................298.721................147.......*.........165.741*794...*......318...&.......*...*...".to_string(),
        "...................878..........................*.........../............947...........314.......*...........999............493.....996.330.".to_string(),
        "...........705.........79........994.645.703.203.258...........706...227*..........+............590....822*.................................".to_string(),
        ".....468..*......*311./...@23...$.....@....................588...*.........317......113....857.............19.#..&260...571...251=....772...".to_string(),
        "......*..11...175..........................................*....259...509.....*...........*.......443..487....73........................*...".to_string(),
        ".....161..............................................832...611..........*609..742.........938......*.*............@909.....66.232..........".to_string(),
        "..........125...............630.....596.......%477.......*........................................601..........158............*......201*864".to_string(),
        "...................819.......=..-.........................198..............=..........418...60............904...............................".to_string(),
        "781...663..250...................281....905.+...187....%..............271..852...........=..*...484...517*..................................".to_string(),
        ".......*......=....865.826...%............&.679..*.....160..576.....................462+...717.............&........389........783....67....".to_string(),
        ".......988............*......79..441............474.........#.....471.......298................./.....*511.445......*......463*.............".to_string(),
        "...........91....807.............*......173.............#27.................*......937.353.....85..510..............109.#............70.....".to_string(),
        "...........*.......*...........955..398...@......75.........*...........32...221../....*....7..........234../481........841.........@.......".to_string(),
        "........#..593......864.....................932.*........960........160*.............953........385...+.....................................".to_string(),
        ".702*..596.........................$....952*.....20.........................................257....*........741.858.......*......839..491...".to_string(),
        "................#........618.....693...............................333*87......173......268*......775..................699.710...*..........".to_string(),
        "..........985..586...818..*..........*723.......437*..........148...................333........................156.............821.....651..".to_string(),
        ".....................#...982......360.......757.....706.122....&............245........-........16.......571.......544................$.....".to_string(),
        "6...381......................657..............#...................112*.....*.....496......388.&....556#.....*428..*................-.....828".to_string(),
        "........#.398.688.900@..674....*....284.860..........-....................588.............*...47.........@........280............86.........".to_string(),
        ".....526.....*.............*...........*.....154......267..960......563.......29.......398........309#....849./........240*685..............".to_string(),
        ".......................692.420.978#.........*.....261.....%........+.........*.....492......$957..............979..................254.691..".to_string(),
        "...978#...131*980.......+.................925.....*...627......519....368*..324...*..................$..................52............*.....".to_string(),
        "....................453........400$............................*................745...+..........-..838..#....118.........=.....815.........".to_string(),
        "....679......796.........920........$...75...290..195.......307...340.....649..........403......165.....26.......*..........711.*...........".to_string(),
        "....*.........%..100.440.........206....$...*....*...................*254..........990..............249..........380....-.....%.535.........".to_string(),
        "..........988.....*...*...................399..723.....*....................107......*.....................49...........422.................".to_string(),
        "...800*......*..183..117..375......375..............807.691........981................890.......622...97.....$.515................@.........".to_string(),
        ".......413.129...........*.............729....&137...........956....$.....976....................*....../..........................334......".to_string(),
        "...313..........794-..807.....*698.....&...........874*.........*...............71........................655...............................".to_string(),
        ".....*.....................193............*547.........459.....338...489..581.......483..@115..125........*..........220....................".to_string(),
        "....907..361*.....243..834.............987.....149..........@.........*...............*........$.......509..698.142../.....@.=750......4....".to_string(),
        "....................-...*.....................*............611........21..251.&......578........................*.......717.......47#.......".to_string(),
        ".........................610.26.............892...............................299............601............721..729........................".to_string(),
    ]
}
