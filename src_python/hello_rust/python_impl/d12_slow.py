import functools
import re
from collections import Counter
from typing import NamedTuple

from tqdm.auto import tqdm


class Range(NamedTuple):
    """Cannot use python range() as range(1,1) == range(2,2)"""

    start: int
    stop: int


def get_targets(line: str) -> list[int]:
    return list(map(int, line.split()[-1].split(",")))


def solve1(input: list[str]) -> str:
    def brute_force_arrangements(line: list[str]) -> int:
        arrangements = 0

        for i, char in enumerate(line):
            if char == "?":
                line[i] = "#"
                arrangements += brute_force_arrangements(line)
                line[i] = "."
                arrangements += brute_force_arrangements(line)
                line[i] = "?"
                return arrangements

        # We didnt find any ?s, so count contiguous groups of #s
        line = "".join(line)
        found_here = list(map(len, re.findall(r"(#+)", line)))
        expected = get_targets(line)
        return expected == found_here

    arrangements = 0
    for line in input:
        arrangements += brute_force_arrangements(list(line))
    return str(arrangements)


@functools.cache
def segment_to_patterns(segment: str) -> Counter[str]:
    segment = list(segment)

    counts = Counter()
    for i, char in enumerate(segment):
        if char == "?":
            segment[i] = "#"
            counts.update(segment_to_patterns("".join(segment)))
            segment[i] = "."
            counts.update(segment_to_patterns("".join(segment)))
            return counts

    # We didnt find any ?s, so count contiguous groups of #s
    found_here = "".join(f"{len(seq)}," for seq in re.findall(r"#+", "".join(segment)))
    counts[found_here] += 1
    return counts


def brute_force_fits(segment: str, targets_str: str) -> Counter[Range]:
    """
    segment = "???"
    targets_str = "1,1,3"
    brute_force_fits(segment, targets_str)
    """
    pattern_counts = segment_to_patterns(segment)
    idx_counts = Counter()
    for pattern, count in pattern_counts.items():
        for overlap in re.finditer(f"(?={pattern})", targets_str):
            s = overlap.start()
            # print(segment, found_here, s, s + len(found_here))
            idx_counts[Range(s, s + len(pattern))] += count

        # print(pattern)
        suffix = pattern.strip(",")
        if targets_str.endswith(suffix):
            idx_counts[Range(len(targets_str) - len(suffix), len(targets_str))] += count

    return idx_counts


def brute_force_segments(
    segment_matches: list[Counter[Range]],
    segment_idx: int,
    at_idx: int,
    goal_idx: int,
    targets_str: str,
) -> list[Range]:
    """
    springs
    target_str
    brute_force_segments(segment_matches, at_idx, goal_idx)
    """
    if at_idx == goal_idx:
        return 1
    if segment_idx == len(segment_matches):
        return 0

    total = 0
    for range_, count in segment_matches[segment_idx].items():
        if range_.start == at_idx:
            # print(
            #     segment_idx,
            #     f"match={targets_str[range_.start: range_.stop]!r}",
            #     f"{range_ = }",
            # )
            total += count * brute_force_segments(
                segment_matches, segment_idx + 1, range_.stop, goal_idx, targets_str
            )

    return total


def solve2(input: list[str]) -> str:
    """
    We use divide and conquer.
    We define a segment as a contiguous group of #s or ?s.
    We preprocess each segment in isolation, and identify which parts of the targets it could match.
        E.g. if the segment is "????", it could match
            "1,1," in 3 ways: "#.#.", "#..#", ".#.#"
            "1,2," in 1 way: "#.##"
            "2,1," in 1 way: "##.#"
            "3," in 2 ways: "###.", ".###"
            "4," in 1 way: "####"
        Instead of storing the parts it matches, we store the index range it maches.
        Consider the target "1,1,2,1,1"
            "1,1," matches the range [0, 2) and [3, 5), so we store Counter({range(0, 2): 1, range(3, 5): 1})
            "1,2," matches the range [1, 3), so we store Counter({range(1, 3): 1})
            "2,1," matches the range [2, 4), so we store Counter({range(2, 4): 1})
            "3," does not match
            "4," does not match
    Now we have a list of segment matches
    We want to find the # of ways to arrange them to match the targets.
    We do this by setting an index to 0 and iterate through each segment
    The segment must have a range matching the index, otherwise we break and try a new configuration
        (We cannot skip, since that implies we add a non-matching value to the result)
    If the segment matches, we:
        1) set the range ending as the new index
        2) multiply our current # of configuration with the segment count for that range
    When we reach the end of all segments, we can add the # of configurations to the total

    Test case 1:
        ???.###????.###????.###????.###????.### 1,1,3,1,1,3,1,1,3,1,1,3,1,1,3

    This ends up being too slow
    """
    total = 0

    for line in tqdm(input):
        l, r = line.split()

        springs = "?".join([l] * 5)
        targets_str = ",".join([r] * 5)

        segment_matches = []
        for segment in re.finditer(r"([#?]+)", springs):
            segment = segment.group()
            segment_matches.append(brute_force_fits(segment, targets_str))
        # del springs # No longer needed

        at_idx, segment_idx, goal_idx = 0, 0, len(targets_str)
        n_config = brute_force_segments(
            segment_matches, segment_idx, at_idx, goal_idx, targets_str
        )
        print(n_config)
        total += n_config
    return str()


sample_input2 = sample_input1 = """???.### 1,1,3
.??..??...?##. 1,1,3
?#?#?#?#?#?#?#? 1,3,1,6
????.#...#... 4,1,1
????.######..#####. 1,6,5
?###???????? 3,2,1""".splitlines()

full_input1 = full_input2 = """?#?##?#????.?..?? 9,1
????????#???#? 1,8
.??????#???#??????? 2,7,1,1
???.?.?.???#.? 1,1,1,4
??#???#?##??. 4,5
??????##??#???????? 1,10,1
?#?#??.???.???? 6,1,2
?#?#??..#???#???#? 6,1,4,2
??????.?.???#?####? 5,1,9
.#?#??#.????#?#??#? 4,1,1,5,1
????..????..??? 3,2,2
.?#??#.??.? 4,2
???#????#??? 2,4
#.??#??#??.????#? 1,3,3,1,1
???.#?????#. 1,1,4,2
??#?#?.??#??. 3,1,1,3
?????#???? 2,4,1
?.??????.?#?#? 5,3
.?????#???..? 7,1
.????????.# 1,3,1
???#.?.?.. 1,1,1
?.???.??????#??#??? 2,2,6
??#???.???????#??# 2,10
?#??#?.????.???? 2,2,1,1,1
????#?##??. 1,6
#?#???#???.????? 8,1
???.?????#???? 1,7
?????#?????#?...???# 11,1,1
?.?#?.??.#?#? 2,2,4
???#.????#??##. 1,1,3,1,2
??????.????? 2,1
???#???#?..??.?#??## 1,7,2,6
?.??#..#???#???.?? 1,1,5,1,1
?.???###?? 1,5,1
???.?.#??#?????.?#? 3,2,1,3,1
???.??.???? 1,1,3
.?##????????.. 6,1
????????#???##?#?#. 1,2,2,8,1
?##?#?????#.????? 4,1,2,4
?????#??.?#? 4,3
?##???.#??.? 2,1,1,1
???.#???#??????# 5,4
?.?????#.???#..? 4,1,1,1,1
.?????#??????..#? 8,1,1
????#??##?? 4,2
.??##??#?????.. 1,9
?.?????????? 1,3,1
?#??..????..??? 1,2
??????.?.????? 2,2
?.??##?.?? 1,4,2
??#?.#?.#. 3,1,1
??.?##???????#.? 2,5,3
???.?#?.?#?#?. 1,1,1,4
??.#???????.# 1,1,3,1
??###???#? 4,2
?.?????#??#???? 1,1,1,5
?..??.?##?????? 1,1,2,1,1
#??#.#.?.???? 4,1,1,2
?#?????#???#??#.#?. 6,1,5,1
?.?###???.????#??? 1,4,1,1,1,4
???#?.#.##?#?##? 3,1,8
??#?#?#??????#??#?.? 1,6,7
##???#?#.???.? 8,1,1
?..#??.????#?#??.?? 3,5
?????#?##??. 2,4,1
??.???###?.?????.? 1,6,1,1,1
??????????#?#??? 2,4,1,1,2
?#???#???#???.?#? 2,9,2
?#??..????? 1,3
??#?.?.????#.? 3,1,2
???#??#?#..???? 2,3,4
?#.##?#?..???#?##.?# 1,2,2,4,2,2
???.?..#?.???? 1,1,2,3
????#?#????.? 1,8,1
?#?????????#?? 1,1,3,5
???.#??#????? 4,1,1
.#????.??? 1,1,1
??.?????#????#?#? 2,1,2,1,4
.???.????? 3,1,1
#????#??##???? 1,9
????#?#?#??.?#?? 4,1,1,2
??????..?#? 5,3
??#?#??#????#???#??. 7,5
??###?.???#??.#. 5,5,1
?????##??. 3,3,1
?.??????#????????# 1,1,12
.????.????? 1,1
???.??#??..?#?..?#?. 3,4,3,2
???????.?#??? 3,3,3
??#???.?????? 2,1
?#?.?##?#??## 1,6,2
.????.??#??#?.... 1,6
.???.#???#? 1,5
.?#.???#??? 2,2
#...??.???#? 1,1,1,1
#.???.?#.??????????# 1,1,1,1,11
????#??.?? 4,1
??#???..??? 5,1
..??????#?? 1,5
????##?#?.??????.? 6,4,1
?.?????????????..? 5,3
??#???????????##???? 5,2,2,6
.?#??.??#???# 3,4,2
????#?#????##? 5,3
?#?.??.???#???#?##? 1,1,12
??.???#.????????##?? 1,1,2,1,1,8
.??????#??? 2,3
?#?????#?#? 2,4
.?????..????? 2,3
.?.???#????.???..?. 4,2
??.??..????????. 2,2
??##????#???.?#? 1,10,2
??????#??.?...? 1,3
??##???#?.????#????? 6,6
?#?????#?#?????? 2,5,3
??#???????#???? 5,4,1
#?.????..?#?. 1,1,1,2
????????#??#####? 3,12
????????#??#? 2,1,6
????##??.?#. 2,3,2
.?.?##?.????#???. 1,2,8
?.#.????.#????? 1,4
??????????.? 1,1,2,1
??.????#??##?. 1,1,6
???.?#??..# 3,3,1
?????#??????.?#.. 10,2
...??.???????#???#?. 1,11
??????.#.??.?.? 3,1,1,1,1
????.#????#?.#?#?? 2,1,2,1,1,1
???#?#..#???? 4,1,2
.????..?#?#??.? 2,6
.??#??###?#?#??#??.. 4,12
??#???#??# 2,1,1
????..#???..???? 3,1,2,1,1
.#??.???#? 1,1,1
?#??#?.???#. 1,1,1,1
?....????##?.??..? 1,1,1,3,1,1
???.#???????#??.#?# 1,11,3
.?.?#????#? 2,1,1
?#??#??#.??#?.?????? 7,2,3
???????????.?. 1,1,5,1
??#???####?# 3,6
??#??#.?????????? 1,4,1,1,5
??####?##??.#.?. 8,1
?????#??.?#?#?? 3,2,4
?.???##?#...?? 7,1
?#?.#?##?#?????# 1,12
.?????#??#??#???.?#. 1,13,1
.??##??#?????# 1,6,2
??.??.?##????.? 1,1,6,1
??..????#?#. 1,2,3
?#?.?#..???? 3,1,1,1
?.##??????? 2,2
????#?###??.???# 3,6,1,2
?#??????#???.??????? 11,3
???..#?##??# 1,1,5,1
???#?..?????? 4,2,1
#?#????.??..?# 5,1,2
?#???.???? 2,2
???###?###??.#.? 11,1
????###?#?#???. 11,1
??#??????#??? 2,2
#??.#...??#? 3,1,1,1
.#.?.?##??#???#.?.#? 1,1,8,1,1,2
?#???????#..#?? 4,1,1,1
##??#?#.???.?.? 3,3,3,1
????.??..????????? 1,1,1,3,1,1
???????#????. 1,1,4
???????#????# 1,5,1
..#??????? 2,4
??#???.???? 2,4
.???#??.???##?. 5,4
?.???##.??????..? 2,3
.#???.?.??#???#??#?? 1,1,1,10
.??.#???#???? 2,9
???????##????????.? 1,10,1
?#.?.#??#?????. 1,1,1,3,1
???.????#.?.? 5,1
?.?#???#??????.? 1,1,2,3,1
??#??..?#.? 5,2
.??#?.#.#.?? 3,1,1,2
??#.?#?.???#?? 3,2,3
??????#???..?.??.?? 8,2
??..??.?#??? 2,1,3
??.???#???? 2,2,1
??????#???.#??# 1,2,2,4
#??.#?#?...??????## 1,1,4,1,1,2
???#????#????.?.???? 12,2
?#?##?.??????? 5,3,1,1
??????.??????? 1,2,4
???..??????..??## 2,3,1,1,2
?.??..????.?? 1,1,2,1
#?.???.?..??? 1,2,1,2
????#.#??#??????#?? 1,2,2,10
?????###??? 7,1
?#??#?..???.#?? 6,3,1,1
?#??.?.?##?#??? 3,1,5,1
??#??#???#???##? 1,2,1,2,5
?#?#.#?....??????. 2,1,2,1,1,1
.????##???..?#. 7,1,2
???..?.??#?#?.?#. 1,4,2
??.?.????.#.????#?? 1,1,2,1,7
?#?????#??.? 1,2,1,1
???#???#?????? 9,1
??..???.?##..?? 2,2,3,1
?.#??????????????? 8,1,2
??#??#?####??.???? 1,7,2
#.???..#.? 1,1,1
?????#..????? 4,1,1,1
??.???##?#???.# 1,5,1,2,1
????.??.?#?. 3,1
#??.???????????##?.? 1,1,13,1
?#.???###?.?.?? 1,1,5,1,2
??#??????#?????????? 11,2
???..????. 1,1,3
.?????????????? 1,4
?.#????.???#????? 5,5
???????.#??#?.. 1,1,1,2,2
?????.????????????? 1,2,2,8
.???????#?? 3,3
??.????#??..?.??#. 1,3,1,1,1,1
?.#??#???.?? 1,1,1,1
.??????????? 5,2
.???????#??? 8,1
.#?..#???#?.#. 1,1,2,1
.???#?#???.???? 7,2
??.?????????#????#.. 2,9
??##???????#????# 5,1,1,1,1
?#????#??.#??.??? 8,3,1
?.#??#?.#?. 1,2,1
#???????#???#? 2,6,3
??##?#?.?#?? 4,2,3
???.#????????.?? 1,1,8,1
##???.??????#???# 4,1,2,2,2
??###?.?#???? 4,4
#?#??.?#?.?.?#?##..# 1,1,3,5,1
.????#?????#?#??. 2,1,7
.???###??###????.?? 12,1
??.???####?.??? 1,5,2
??#????????.?##??## 1,1,1,1,6
???##????#????????## 1,5,1,5,3
.??#?#??#?####??.? 5,8,1
???#??##...#????? 8,3
.??...##????.? 1,5,1
.??#????????#? 7,3
.???.?##.??????.? 3,3,1,2
????#??##??#?. 3,5
??##??#???#.? 7,2,1
#.??#??#??#???.??? 1,2,7,1
...???.#.??? 2,1
#???.?##?###??# 1,2,2,6
????.?#??.? 2,1,1
???..?#?#??.#???? 1,6,3
?..?????#?? 1,1,2
.?##??.?.?#? 5,2
###???????#?? 3,2,2,1
????????#?##??.. 1,1,4,3
??.?.?#????#?..#.#?# 1,5,1,1,1,1
.#???#?.#???? 1,1,1,5
?????.?#?.?#?? 2,1,2,3
?#???????????#?###? 1,1,1,8
???#???#.#??? 1,3,1,1
??#?#????????? 3,2,5
?.???????#???# 2,6
??##???##??. 4,5
????#?.??#??#???#. 4,9
#??.???.?.??## 2,1,1,2
?#??.????#?.? 3,2,1
..#?##.?.##??##???? 4,7
.??.?##???#???#?.?? 8,1
#.?????#?????? 1,6,1,2
?#????.#?.??.#?? 5,1,1,1
?.?.#?#??????.? 1,1,4,1,1
??.?#????.??#..#?? 5,2,2
?#??#????. 2,4
?#????#??#?.#?? 1,1,5,1,1
#??##??#??#? 2,3,1,2
??.?.#???#?.??#?#. 2,2,2,3,1
.##????.?##.?? 3,3
#?.???.??#?#???.?#? 2,2,2,2,2
??.????#???????#?? 2,3,1,1,3,2
??#??#.#??#???#?.? 1,1,1,5,1,1
??.????###.?. 1,5
?#???###?.????? 1,5,2
????#?#???.? 7,1
.???#???### 3,1,3
??#..?#??. 3,4
?????##?.?? 1,4
?.??#.??????#?#??#? 1,2,1,5,1
????..??#?? 3,2
#.????.?#???##??# 1,1,10
??????????..?.???? 7,2,4
?#.????????? 2,3,1,2
.?????.#??#? 2,4
???#?????#.????.? 1,7,2,1,1
..???##?????#?? 8,2
?#????????? 5,1
????#?#????. 3,2,1
???..?..#?..# 3,1,2,1
.????.???????? 1,3,1,1
.????#?.???#??##?.?? 1,3,7,1
..??#?#???..#?#???? 3,1,1,4,1
.??.?????.?#?##??.? 2,1,6
???#.?#.??#?? 2,1,1,2
?.??????#?????????. 1,5,1,2,1
???##?##?.???#?. 1,6,2,2
.??#....??.? 2,1
.??????.?#???.??? 1,2,1
??.??...?##?##????? 2,9
.#??#?#?????????.??? 11,3,1,1
???#??#?#????.???? 12,1,1
???.????#??? 1,1,2,1
?#.??#???##????. 1,12
?.????????#?? 1,2
.??###??????????#?## 5,1,7
.#?##.???.?.?.???? 4,1,1,1,1,1
?#??###??##..?##? 1,7,3
???#.??.?###?#.? 4,1,3,1,1
???????##?##??#.. 3,1,8
??#?#.???#?#????? 4,1,4,1
?##??#??#?##?? 2,1,6
#?#?.?##?????. 1,1,8
????????.#? 6,2
.??#.?#?#??.?. 1,5
?.?#?.?.????? 2,1,2
?#????#??????.?????? 2,1,1,3,2,3
????????#?.##.?.?? 8,2
?#????#????????#.??? 5,3,2,1,1,2
#?#????#..???????#? 1,3,1,4,1,1
.#???#.???????.#???? 5,1,1,3,1,3
.??????.?#?##???? 5,6
?.??#.?????#####???? 1,1,9,1
#???#????#.??.?## 2,2,4,1,3
#????#????#.?#???#?. 1,1,1,4,5
?#????.??. 5,1
????##?????? 7,2
?#?#??#?#????.?.#?? 9,1,2
??##.?##?#??.??..?? 4,4,2
..??.??????? 2,7
?#??#.#?##????? 4,1,6
??.?#?.?#?.?????? 3,1,6
.#??????.?? 4,1,1
##??.##??.?##?#???? 4,4,6,1
??????#?????#?? 10,2
?##??????? 3,5
.??????????.#?#.? 9,1,1
..???#????##??#? 2,1,8
??????#??#???????# 1,1,1,8,1
?..???.???#?##?#. 2,6
?#????##.???#?# 2,3,6
?#????#??? 4,3
#?.??????????#???. 1,1,2,3,3
????????????..?.? 1,4
##?#??#.?#??.#??# 7,1,1,4
??.?????????#..???. 1,1,8,2
????#?????.?#? 2,1,3,2
.?#??..#??? 3,1,1
?#?#?????#????? 1,1,9
#???#?#?#?.? 1,7,1
#??????##??..?#?#??? 2,6,6
.??###??????#???. 3,3,3
?????????????##.?? 1,1,8,1
????????#.??#???# 9,2,1
???#????????? 1,6,2
.?????.???.??.. 5,1,2
?#?.??????.??# 1,6,1
???#???.????? 2,1,3
.#.????#..?##?.????? 1,1,2,3,2
?#?.?#???#?.?. 2,6
.##?#.#??#???????### 2,1,1,1,1,4
????#???.????.#.? 7,1,1,1
#???.????? 1,4
##??#???#??????????? 5,10,1
?#??????..??? 5,1
.???#??#?##? 1,7
??..#?#??????#. 2,4,3
?.??????#??.???.?.?? 3,5,1,1,1
??????#?.??. 5,1
#??.??#?.?#?##??#? 3,1,1,5,1
##?#?.?.#? 5,1
????#???.? 4,1,1
.??#?#????..?????? 1,1,3,1,1,1
??#????#?##???????? 1,1,11,2
#??.?#?#???.# 1,6,1
??.??????.? 3,2
???#?.?????#?##?#.# 4,1,7,1
????##???#?.??.# 2,5,1,2,1
?.?###????#?#??#???? 11,1,1
???#.????.?.?#?#??#. 4,3,1,5,1
?##?###?????.??? 9,1,2
??#???.????????#???? 4,1,8,1
#?#????.???.? 6,1
?????..??.????.??? 1,4
.??.???.??.?#??.?.? 1,2
.?.??#?.??#??#??#? 3,7
?#?????..????? 4,1,2,1
????????????#?? 4,5
??.?#???#??.??? 1,3,2,2
##??#?.????#??? 6,7
#?????.?###?##? 1,1,7
?.??#?#??# 2,4
?#???????# 1,2,3
????.????..##? 2,4,2
???????#?#? 1,6
???#.??#??.? 1,4
??###?###??..?????? 11,2,1
?????.?.??.#?.? 1,1,1,1,1
?#?????#.?#??. 2,5,4
??.????#?????#???#. 1,1,2,7
??###????????.? 4,2,1
?????.?.???.? 1,1,3,1
.?#??????#??.??##?#. 4,2,3,6
?##???#???#?? 2,3,3
????#????##??????? 1,13,1
???.??????##.... 2,3
.#??#???.???.?#?? 1,4,3,3
#??#?????#?#???##?? 2,10,3
?????##.??#?#??. 7,1,5
???#????#??? 5,2
????#???.?#??#???? 1,1,1,9
#???##???. 2,4
.#???..#????#??? 2,2,5
?????????#?? 7,1,1
?#??#????.???? 7,1,1,1
??.?#???#????????? 2,3,6,1
.?..??#?###. 1,7
???#????.?#?????? 4,1,2,2,1
.????#.???. 4,2
.???????.? 4,1
.?????????.??#? 1,1,2,4
.??##?##?????.?# 2,2,1,1,2
??????.#.?#? 2,1,2
?#???.???.??#????. 4,3,1,1,2
??#.???.??? 2,3,2
.????#????#??????? 10,4
.#.??#..?. 1,1
????????..?#???# 2,2,2,4,1
##??????.???.?#.?? 3,1,1,3,1,1
###???.?#.?#?#????# 3,2,1,4,2,1
#?.###??#.??? 2,3,1,1
???.??#..??.??? 1,1,1,2,1
??#?..?.?..?##???. 3,4
?..???#?#?? 1,7
????#?#????##??????? 10,1
.?????????.??.??##?? 4,1,1,1,6
?#???..?????. 2,1,1,1
?#.??#????? 1,3,1
.???##?#???#?. 1,4,2
..?????##??????.? 8,1,1
?????#?..??. 3,1,1
????#??#?.?#??. 6,3
????.?.##?????###? 1,1,2,2,4
?????.?#???? 2,1
#???#?#??.#.?. 1,6,1,1
????#.?.#??#??#??## 1,1,11
??##?#???#?.?.????? 1,8,1,1,2
.##??#.?#?? 5,1,1
.?#???.??????..??? 5,1,3,2
.???.??????.##???? 3,1,5
???#?#??#??????.???? 13,1
??.?#??.?# 1,2,1
??#????????.??.?.#? 1,9,2,1,1
??#??#..??#.? 4,1,3,1
#?.#??#???#???.??? 1,9,1,2
??#?????????? 1,1,3,1
????..?.?#?.???? 1,1,1,3,4
?#??.?#???? 1,5
?##??.??#.??..????? 2,3,3
.??.?????? 1,1
?##?#?##????????.?? 3,1,4,3,1,1
.???#?#?#?????#?? 4,7,3
?#??#???..? 4,1,1
...?###????#?#??#??# 3,8,2
???#????.??????#???? 2,1,7
#???????##?####.?? 1,1,1,2,4,1
??#.????#?????. 1,1,6
#??????#?.#? 1,1,1,1
#??#????????.?? 1,1,3,1,1
?#?#??#??? 3,2
..????.?#?. 1,2
??????##????. 5,3
????????.??#??. 6,1
.#?##????.?#?#.??? 8,2,1,3
??#?.????#????? 3,5
????#???????? 1,8
??.??#???#?? 1,1,4
???...???..? 1,3
..??##??#?#.?##### 9,5
..?#?.???. 2,1
#?#???#.#???#???? 1,2,2,2,5
??#???.??.?? 4,1,1
..???.?????... 2,1
?..?#???#?..??#????? 7,7
?.?...???#. 1,4
?..?#???#????? 6,2
??#???????#?????#?.. 2,9
?#??#???###????#. 1,7,1,1
???#..?#????.?##??# 4,5,3,1
.??#..#??.?? 3,1
????.#?.??..??#? 4,2,1,4
#????????#. 1,5,1
????#??.#.??? 4,1,1
.#?#?#??????? 1,1,8
???#?????.# 4,1,1
?????#??#.???.?. 7,1
??????????? 3,1,1
##??#?#???????# 5,1,4,1
?#???##?.??#??#????? 3,3,1,9
#????#.????#.?? 3,1,1,1,1
.??#.?#.??#?? 1,1,2,3
?.??##?##????.??.#.? 1,7,1,1,1
##???????.? 2,2
??#??.?#????. 2,1,3
?....#?#??. 1,1
??##??.?.??#? 4,1,1,2
??..?.?????# 1,1,1,1
.??.?????? 1,1
????#??..?#?#??#. 4,7
?##????#.??# 3,3,3
?#?#????.##?#?? 5,1,2,1,1
.#?#???.##? 1,4,2
.??????..?#??? 1,3,3,1
?##??#??.????? 6,1,1
.???.??... 1,1
.##???###???#?#?? 14,1
#?#?????###?.?????. 3,5,3
???.?#?#??#?????.?? 1,1,7,1,2,1
???#?.??##?? 1,4
#?#.???#???. 3,4
???.?.???.#???#? 1,1,2,1,2
..#??????#???? 4,4
.#???????????#??.. 1,3,6,1
.????###???#? 1,1,5,1
?.??????#???...?? 2,5
?????#??????.??#???? 7,1,3,1
??#?#..#??.#??? 2,1,2,1,1
.?#?.?#??#? 1,5
#???##??????????? 1,10,1
????#?###?#?.??.?.# 3,8,1,1,1
??.##????##. 3,1,2
.??##.?.??? 2,2
?#?#???????????##??? 11,4
?.?????#?.????#?? 1,1,1,1,4
?#?##?????##??????? 2,12,1
?????????#????.??? 10,1
???.#???.? 2,4
?#????.?#.?#?..#?## 2,1,2,2,1,2
???.#?#?#.?????? 5,2
.##??#?#??#?? 7,3
#.????#?#?#????.?? 1,3,7,1
??##???#???#??.?#?? 10,3
????#?????#. 4,1
?????.???? 4,1
?##??????#?##.? 2,7
.?##?????#?#?? 6,1,1,1
???????.???##?? 1,2,5
.?.??#????#??#??###. 1,1,12
??#??#???#.????. 5,3,2
?##??#??.???#??? 8,6
?##??.???????? 5,1,2,1
?.???.?.????#???# 1,3,1,2,5
??#?#????#???#??#. 3,2,9
?#.??????.??????? 2,1,1,1,4
?????#?????. 2,1,2,1
???.??#?#..???# 2,1,1,1,1
?#????????. 2,1,1
???#??..??.??#??. 3,3
????????..?? 2,1,1,1
.??..??#...?#.???# 1,3,2,3
?????###??.?? 4,1
????#?????? 6,1,1
.???????#??## 3,6
.?.???#???????#? 1,10,1
?#.???#??#?#???? 1,4,8
.??????##??? 1,4
#??##.?????#???##??? 1,3,1,8,1
????#????#?###????# 3,1,7,2,1
??.????###?????? 1,1,7
?#?#?.???.##? 4,1,2
????.?..???#?#? 4,1,1,5
?#???.?#??. 1,2
#??#????????????. 1,7,1,1,1
.?#..#?.##?#.??? 2,1,4,2
??.???.??#????#??#? 1,1,1,6,1,2
?..#??#.##?.#. 4,3,1
???###??##????# 1,7,2,1
###?????###?#??#..?? 13,1,1
.#?????#??? 1,6
?#??#??.??.?.? 6,1,1,1
.#??.?#..?#??? 3,1,4
??#??.?##??? 1,1,4,1
.#????#?#.?#?#?##??? 8,7,1
?#??#?#.???????. 7,3
#?.??#??##??????. 2,6,2
.#??#?#??.? 1,5
.????#??????#??? 2,7,3
.???#?#????.? 1,4,1,1
?#..???.#? 1,2,2
.#??????###????? 6,7
?.????.???#?? 1,1,1,2
??..??????.##?##???. 2,6
.#?#..?#????.?? 3,5
.#?#?????????? 5,1,1,1
.?.???#?#??.? 1,3
???#.?#?..????#?###? 2,2,8
.?#???.?.???##?.?.? 2,1,5,1,1
???????..#?##? 2,1,1,2
.?#?????.??#. 3,1,1,1
???#????#??.?.#?? 1,8,1,1,1
?????.????#??#?#? 3,11
#..?.#????#??#?..? 1,9,1
#.?.?#??.??? 1,1,3,2
????.????.?##???? 1,1,2,3,1
..??.?..???.?.?? 1,1
.???.##??#??#???? 1,1,6,1,1
#.#?????????# 1,1,3,2
#??#?#???.?????.? 1,5,1,1,1
??.###???..? 5,1
?#?#??##??#??.??. 4,7
??#?????????? 5,3
?#???#???. 2,2
??#??#?#??#?? 6,1,1
?.???#.?#?# 1,3,3
???#??????#???#?. 1,10,1
?.?#?##?.?? 1,4,1
#??##??.????#??. 1,3,6
#.???????#? 1,2,2
?#?#??.?.?#?#.?#? 3,1,1,3,2
??#???.?#?????? 2,1,6
.??#???##???# 1,2,7
??#??#???#?#?.?.?. 1,1,8,1
##???.?..??#?? 2,1,1,2
?#..????.????????#?. 2,2,10
??##?..?##????###.?? 4,10
?#?..??.?? 1,1,1
??????#??..??????.#? 8,1,1,1,1
???????.#?????..??.? 2,1,5,2,1
#?#????????##??? 4,1,1,6
.???#?..?????? 1,2,1,4
.#..???.??##??. 1,3,3,1
????#??????#???????? 1,1,5,2,1,1
?.?###?#?#?#?#?#?.?? 14,1
?.?.?#??????? 1,3,2,1
?##????????#?#??.# 5,1,3,1,1,1
???.???#????? 1,6
?????####?????#?#? 1,11,3
?#?.???#??? 1,2,1
..#??##??? 6,1
??????.??.. 2,3,1
.????#?.#???.?? 1,2,1,1,1
.??##?##??..??###??? 7,5
#???#??.??.?#.#.?. 1,2,2,1,1,1
??????#?#??.?? 5,1,2
#?#??#??????.????.?? 9,1,1,1,1
#?#..????#?????###? 1,1,1,4,7
.?.?????#.?# 1,1,2,1
?.???#?##?????#????? 5,2
#?????.??? 2,1,2
?????#??#?#????#?? 13,1
?.??#????#..?? 5,2,1
????#??##?.?.? 1,3,3,1
?.????.?##???#? 2,7
#?#?????#??.??##?? 6,1,1,1,2
???#?#??????#???.?.? 4,4,1,1,1
???#???#?#?.#? 4,5,1
??.?#???????????. 1,5,4
.?#.?????#.? 2,2,1,1
????.?#?###???#?.#.? 2,11,1
??#??????##?#?? 2,9
???????#?#?##??????? 3,1,7,1,1
???##?....??????? 6,6
?#.?#?.##?#?#. 1,1,2,3
??????????#? 4,2
#.?###?#???#?##?#?.? 1,13,1,1
??#?#?.?.???.??##?? 6,3,4
???.#?????##?.# 1,1,8,1
??????#?#?? 8,1
?#??????#??#?. 6,1,1
.#?#??#.#?#?#?.? 6,5,1
?????????#??.??#?#? 7,2,3
.????#??#????.??#? 8,1,3
??.?#???##?#??##??? 2,12,1
?#???###?.???.?? 7,3,2
#????.#???.???#..# 1,1,1,1,4,1
????##?.#? 6,2
??????####?.# 7,1
????#??.#. 1,4,1
.????#?????????##?? 15,1
???.????#?# 1,4
???????###. 1,5
#?.?????#??#?? 2,6
?????##????.#??#.?? 8,2,1
??####????##???.# 13,1
?..??#??#.?#?????? 1,3,1,1,1,1
.#???#???????#??#?? 6,1,8
??#?#..???? 4,2
.?#?.?.???? 2,1
.???????????? 2,1
????????#?.??? 1,1
??#???#???. 2,4,1
#??.????#.?. 3,3,1,1
?????#.?.?.????. 5,2
???#???.???? 1,5,1,1
#.?.?????#????? 1,6,1,1
?#?..#?#.??.??#?. 2,3,3
#????..???. 5,1,1
?#??#?????#???#. 1,3,1,1,3
???#?????????????.?? 4,2,1,5,2
????...?..??.????? 2,1
??.?..?####?#?#????# 1,14
???###?##??#?# 9,1,1
??.#??.???##? 1,3,5
??#??#???????? 1,2,1,2
?.###??##??.?#.. 9,1
?????#???? 1,1
#??????#?#???.?##?. 1,8,3
.?.??###?# 1,7
?????????##???.???# 1,2,1,4,2
?.?#???#???#.???? 2,1,2,2,1
#????#??????.?? 4,3,1,1,1
??????????.? 3,3,1
?????.??#?## 2,4
?###?#??.????..? 8,2,1
?????.##???.?? 3,4,1
#??????.??# 1,3,2
?#?????????#?.?? 7,3
????#??#?.??????. 5,1,5
.?#?#??#?.???### 8,1,3
??.?#???.???????.? 2,4,1,5,1
??.??#????.#?#???? 1,1,2,1,1,3
????????.???# 1,1,1,2
???#??#?#??.????#. 5,2,5
??.??.?#?.#?#? 2,2,1,4
.#????.#???????.?? 1,1,1,5
???###??????????.?? 15,1
???????##.??.??# 6,2,1,1,1
???????.??? 6,2
????????.?#?#.??#??. 3,3,3,4
????#?..?.. 3,1
?#??#?###???##?#?? 2,13
????###??? 2,4,1
??.?#??####?.??##??? 9,6
?#???..???.????? 4,2,1,2
??#??##???? 3,2
?#??#?##?????# 1,2,6,1
..????..???? 4,1,2
?#????.???..#???? 2,2,2,2,2
?#????????#??#??? 1,13
#???..#???????# 1,1,1,7
#?#.#????.?? 3,1,1,1
?.???????..?.?? 1,4
?.#??.????? 1,1,1
??#?.?????#. 3,3,2
.?.#??##?##???#? 1,12
??#????#??.#? 8,1
??#???..####?#??#? 5,7,2
???.#?#?????#?????? 1,6,2,2
??.???????#??##?#.. 1,2,4,4
#.??????????#???? 1,1,11
???#?#???#???. 1,4,2,2
?????.????? 1,1,4
??????#??##??. 9,1
??#???#?.??? 6,1
????.???##?.??.#??? 2,5,1,2,1
??.#?.?..?#????.?? 1,3
?#?#.??#.? 3,1
##??#?.#?????#?????? 3,1,3,1,1,4
????.?#???#??#?? 1,1,5,2,1
?????..?????? 4,5
??#..?#.?.????????#? 1,2,6,1
?#??#?##???#???#???. 2,8,1,1
????#????#.????.#? 1,5,1,1,1,1
?????????# 1,1,2
??#???##??. 3,4
?#?????#???#?? 1,1,6
??#??.#?#???#?????? 2,1,5,3
??????????#???#. 2,6,1
?????#?#??????#????? 11,1,1,1
?????#.?.?...??.?# 1,3,1,1,1,1
??#.#???#???????? 1,1,10,1
???#?.????.??#??# 1,3,1,1,6
#??????#.??#?.? 2,1,1,1,2
?.???????.??? 5,1
???#...?#?? 1,1,2
????.?????????.? 1,8
?##?#?##?#???###??? 3,14
??????#???#?#?#???#? 1,16
?.?????????????? 1,2,1,4,1
?..?.?#??##?..?????? 1,1,6,2,1
.?###?#?.??# 7,2
???#.#????.???? 1,2,3,1,3
?#.????#????? 2,1,5,1
#.##?????.#..??#???? 1,2,2,1,5
??#?##????.#???.?.?? 3,2,1,4,1,1
?.??#.?????#?#.. 3,6
????##??#??? 1,1,7
??.#?##??.? 1,6,1
??.???#?.??##????? 1,1,6,1
?#??.????###??.? 2,9
?????#??#???#.??. 1,7,1,1
?????????#? 2,3,1
#?????????.???? 8,4
??.#?.#?.?? 2,1,1
.????##?????#?#? 6,4
#??????.?#????? 1,2,6
?#???????. 3,4
???.???##???.??#? 1,8,2
.#???#??#????#??? 1,13
?.?????#????? 1,2,1,4
??.??????? 1,3
.????#??#?????# 8,1,1
.??#???#????????? 3,4,3
#?????#???#?#?.????? 7,4,1,1
???#.?.#??.??????? 4,1,1,1,4
???????#?? 3,3
??#???#???? 3,6
?????#????.?? 5,1,1
.???#?#..##.? 2,3,2,1
?#?.?????#?#?? 2,1,5
#.????.?????? 1,4,2,1
???#???..?#??#???. 6,6
#???.#?#?????#?? 4,10
#????????? 2,1,3
?#??#?#.?#?#???# 1,1,1,4,2
???????##?#?? 2,7
..??#?????.?#??? 5,3
..????????.???.? 1,1,2,1
?.??#????#?? 4,1
???.??.????.??. 1,2
.?????????###.?#?? 5,1,3,1
???.?#????#????? 1,8,1
??.??.???.??? 2,1,3,1
?.??###???????.. 4,3
????????????.#??? 3,3,1,2
???#?.#?###??#??? 1,3,5,1,2
?#??#???..??#?.. 7,4
#.??##?????. 1,1,4,1
?.??.#????#?#??#? 1,1,12
????#??#?.? 7,1
????#??.?? 2,3
?..??#?.????# 3,1,2
?.#?#???#???.#? 1,5,3,1
##??#?#???###?? 2,11
???#####??????? 2,10
??#?#?#?.?. 6,1
????..????..#?#. 1,1,3,1,1
.#?????#???##?#??? 14,1
#.??.?.??#.?.?? 1,2,3,1,1
?#??????.????.???.? 3,1,1,2,3,1
?.?.???#?? 1,1,2
??#?##????? 4,1
?.?#??.??. 2,1
??.???#.?? 1,1
##.?.?#?????.#? 2,5,1
?##?#.???????. 5,1,4
..?##???#.???? 6,2
.???.??????#?#?. 1,7
?????#.??#? 2,1,2
.#?.#?????????? 1,1,1,5,1
???.?????##??..? 2,1,1,4,1
?????##..? 5,1
#?????????#???? 1,3,1,3,1
?#????..???????##? 1,1,10
???#????#.??.????#? 1,2,1,1,2,6
??##.?.???.??..#? 3,3,1,2
?.?#?#?.???#?#??? 4,4
?##???.??#?.? 2,1,1
#?.??##??.?.#?????? 1,6,1,1,1
???#??#???.?##?? 7,3
?##??.?.?#????????#? 3,2,1,1
?..?#?.##?#?.? 2,5
?..??????? 1,2,2
??#?????.#???#??. 4,7
????.?????.. 2,4
.??#?.??.??..??????# 3,1,1,4,1
#???#?###??##?.? 1,11
??#??.???????#??#? 5,10
?.??#?..##?. 1,3,3
??.???.?.? 2,2
#??????##?##.?? 4,6,1
???????.?#????.?? 2,1,2,3,1
.??#???#???#?##.#.?? 13,1
??.??#?#?? 1,5,1
?#?#?#.?????.?? 2,3,2,2,1
????.???#????#? 1,1,2,4
.?????.????#. 2,1,1,1
.???.????.?? 1,1,1,1
?.????.?#.??#. 4,2,2
??????.?.???#?? 1,1,5
????????.?#???#?? 5,5
????####??##?? 7,5
.??##??????.???.? 10,1
#??#???#??#??? 1,3,4,1
.#???.????? 2,3
..??#??#??#??#?? 2,8
??????##??.???? 2,1,4,1
??????##??????????? 1,5,5,1,1
??#?.??????.?????? 3,1,1,1,1,2
???#.?#??? 2,2
##.??????#????# 2,2,8
?#????????? 5,3
?#?..????.?# 2,1,2
#??.?.#???#????# 1,1,1,3,1
?..??.??????? 1,1,1,2
?#?.?######?#???? 2,7,1,1
??##???.?###? 5,3
??#.??##..???????? 2,4,4
??????.#.??##?. 2,1,5
????#?.??? 1,2,1
.???????.?.? 2,2,1
?????#???????? 2,3,2,1
?.??.#?#?# 1,5
??.???.?????.?? 1,2,1,1,1
???.?..??? 1,1,2
????.?.??.? 1,2
?.????#??? 2,3
?????#???????.?? 7,2,1,1
???????.?## 1,4,3
?.?#?????? 4,1
??????#????#..?????? 11,3,1
#?##????##???##.? 4,1,7,1
?#???##??????##?#? 2,3,1,4,1
??..#?????#??.?? 1,9
?###.????.???#???? 3,2,1,6
???#????.????##??. 3,1,4
????#???.?##?. 1,1,2
.???#??##?#?# 1,6
#??.?????.?.? 3,4
?.??#?#?#????? 8,1
?????.????? 1,1,2
?.#???#????????#.#? 1,8,4,2
???#???#??#??????#.? 6,1,2,2,2
????.???.??????#? 2,1,7
??#.?????.?. 1,2,1,1
?#?##???.?#???????# 1,5,1,2,1,1
??????#?#.??? 3,3
??##??????..#??. 7,2
????.?.??.? 1,1
?????#??#? 2,1,2
???#?.???????# 4,1,3
??##????#?#?? 5,1,1,1
??##?.#?.#????????. 1,2,1,1,1,4
?.??.???.#. 2,1,1
???#??#?????###???.. 9,6
???????.???#.?# 1,2,3,2
???#?.####??????. 1,3,6,1,1
#?#??#?????###?#. 1,8,3,1
???#?????? 1,3,2
#?#??????#??#?.?? 13,2
.?????#.??#? 1,1,1,2
.###..?.???#??.?? 3,1,6,1
#??#???#?..?????###? 1,6,3,3
.??????#???. 1,3,1,2
#????#??.??????#?? 1,1,1,1,1,5
?????.??#??#???#?? 4,11
????#???#??????? 6,1
.??##?.?..?.#??#. 4,1,1,1,1
???#?????#??? 2,5
#?????.?????.?#? 3,1,5,3
??.#??#?#.? 2,1,1
?#.?????????.?. 1,7,1
###???#?????#????#.. 13,1,1
..???????.?.#.?? 1,4,1,1,1
??.#?#????????? 3,1
.????????.??#?#??? 5,7
?#.????????#???.? 1,2,1,4,1
?#.??##????#??#####? 1,6,8
???.?#?#???#?#. 2,5,3
##..?#????.# 2,6,1
#??#.#???##.. 1,1,1,4
.?.?##?????.?? 3,1
.#..#.??#??#?##?##.. 1,1,11
.?.?????##???#?. 1,7,3
?#???#????#???# 2,3,2,1
?##?#????.?# 7,1
?..??#?????? 1,1,1,4
..#?.?#?.???#???#? 1,2,4,3
????????.????? 3,2,4
???.???#?.?...# 1,1,2,1
#??###???#??? 6,2
?.?.?.?.#.?? 1,1,1,1
.?##?#??.??#???##?. 5,7
??.?????#?????? 2,9,1
.?#..?##??..#??# 2,4,4
????.??????#?????? 1,9,2
.????.##???? 1,2,4
.???.??.#?? 2,1,2
..???#???? 1,3
.??#???..?? 2,2,1
?#?#?????????.???? 13,2
???.??#??... 2,3
???.?#????#??. 1,6
?.??##??##????? 8,1
?.??#?###??#.?#?? 9,1
??###.?????#????##? 1,3,8,2
?????#??#.#.???###? 1,5,1,7
?...?#????. 2,2
????.??#?.???? 2,3,2
??.?????#.. 2,3
#??#??????.. 2,2,2,1""".splitlines()

if __name__ == "__main__":
    input = sample_input1
    # input = full_input1

    # print(solve1(input))
    print(solve2(input))
    # print(solve1(input))
    # print(solve2(input))
